name: build-windows

on:
  workflow_dispatch: {}
  workflow_call: {}

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, windows-11-arm]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install frontend deps (gui)
        run: pnpm --dir gui i --no-frozen-lockfile

      - name: Build CLI (release)
        run: cargo build -p website-searcher --release

      - name: Stage Tauri sidecar
        shell: bash
        run: |
          mkdir -p src-tauri/bin
          TRIPLE=$(rustc -Vv | awk '/host:/{print $2}')
          cp target/release/website-searcher.exe src-tauri/bin/website-searcher-$TRIPLE.exe
          # Stage CLI into wix/bin and ws.cmd launcher (inputs for WiX fragment)
          mkdir -p src-tauri/wix/bin
          cp target/release/website-searcher.exe src-tauri/wix/bin/website-searcher.exe
          cp scripts/ws.cmd src-tauri/wix/bin/ws.cmd

      - name: Build Tauri (msi)
        uses: tauri-apps/tauri-action@v0
        with:
          args: --bundles msi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install MSI and test
        shell: pwsh
        run: |
          $msi = Get-ChildItem -Path target/release/bundle/msi -Filter *.msi | Select-Object -First 1
          if ($null -ne $msi) {
            Write-Host "Installing MSI: $($msi.FullName)"
            msiexec /i "$($msi.FullName)" /qn /norestart
            Test-Path "C:\Program Files\website-searcher" | Out-Null
            Get-ChildItem -Recurse "C:\Program Files\website-searcher" | Select-String -Pattern "website-searcher(.exe)?" | Out-Null
          }

      # NSIS removed: MSI only

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: website-searcher
          name: website-searcher
          files: |
            target/release/bundle/msi/*.msi
            
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
